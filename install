#!/usr/bin/env bash

set -e

check_aur_status() {
	echo "Checking AUR status..."
	local aur_url="https://aur.archlinux.org"
	local timeout=10
	local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

	if curl -s --connect-timeout "$timeout" --max-time "$timeout" \
		--head "$aur_url" >/dev/null 2>&1; then
		echo "[$timestamp] AUR is UP"
		return 0
	fi
	echo "[$timestamp] AUR is DOWN! Install aborted."
	exit 1
}

detect_distro() {
	if [ -f /etc/os-release ]; then
		. /etc/os-release
		echo "$ID"
	elif [ -f /etc/arch-release ]; then
		echo "arch"
	elif [ -f /etc/debian_version ]; then
		echo "debian"
	else
		echo "unknown"
	fi
}

install_ansible_debian() {
	if ! [ -x "$(command -v ansible)" ]; then
		echo "Installing Ansible on Debian/Ubuntu..."
		sudo apt-add-repository -y ppa:ansible/ansible
		sudo apt-get update -y
		sudo apt-get install -y curl git software-properties-common ansible
	fi
}

install_ansible_arch() {
	if ! [ -x "$(command -v ansible)" ]; then
		echo "Installing Ansible on Arch Linux..."
		sudo pacman -Sy --noconfirm curl git ansible
	fi
}

DISTRO=$(detect_distro)
echo "Detected distribution: $DISTRO"

case "$DISTRO" in
ubuntu | debian)
	install_ansible_debian
	;;
arch | manjaro)
	check_aur_status || echo "Install aborted: AUR is currently down"
	install_ansible_arch
	;;
*)
	echo "Error: Unsupported distribution: $DISTRO"
	echo "Please install Ansible manually and run this script again."
	exit 1
	;;
esac

ansible-galaxy collection install -r collections/requirements.yml

ROOTDIR="$(git rev-parse --show-toplevel 2>/dev/null)"
HOSTS="$ROOTDIR/hosts"
PLAYBOOK="$ROOTDIR/setup.yml"

if [[ -n "$CONTAINER" || -f /.dockerenv ]]; then
	if [[ -n "$ANSIBLE_VAULT_PASSWORD" ]]; then
		echo "Using vault password from environment variable"
		ansible-playbook -i "$HOSTS" "$PLAYBOOK" --become --vault-password-file <(echo "$ANSIBLE_VAULT_PASSWORD")
	else
		echo "ANSIBLE_VAULT_PASSWORD not set, prompting for vault password"
		ansible-playbook -i "$HOSTS" "$PLAYBOOK" --become --ask-vault-pass
	fi
else
	echo "The BECOME password is your sudo password."
	ansible-playbook -i "$HOSTS" "$PLAYBOOK" --ask-become-pass --ask-vault-pass
fi

echo "Ansible: Bootstrap complete. Successfully set up dev environment."

exit 0

#!/usr/bin/env bash

set -e

detect_distro() {
	if [ -f /etc/os-release ]; then
		. /etc/os-release
		echo "$ID"
	elif [ -f /etc/arch-release ]; then
		echo "arch"
	elif [ -f /etc/debian_version ]; then
		echo "debian"
	else
		echo "unknown"
	fi
}

install_ansible_debian() {
	if ! [ -x "$(command -v ansible)" ]; then
		echo "Installing Ansible on Debian/Ubuntu..."
		sudo apt-add-repository -y ppa:ansible/ansible
		sudo apt-get update -y
		sudo apt-get install -y curl git software-properties-common ansible
	fi
}

install_yay_arch() {
	sudo pacman -Sy --noconfirm base-devel
	TEMP_DIR=$(mktemp -d)
	git clone https://aur.archlinux.org/yay.git "$TEMP_DIR/yay"
	cd "$TEMP_DIR/yay"
	makepkg -si --noconfirm
	cd -
	rm -rf "$TEMP_DIR"
	echo "Yay installed successfully!"
}

install_ansible_arch() {
	if ! [ -x "$(command -v ansible)" ]; then
		echo "Installing Ansible on Arch Linux..."
		sudo pacman -Sy --noconfirm curl git ansible
	fi
	if ! [ -x "$(command -v yay)" ]; then
		echo "Installing Yay..."
		install_yay_arch
	fi
}

DISTRO=$(detect_distro)
echo "Detected distribution: $DISTRO"

case "$DISTRO" in
ubuntu | debian)
	install_ansible_debian
	;;
arch | manjaro)
	install_ansible_arch
	;;
*)
	echo "Error: Unsupported distribution: $DISTRO"
	echo "Please install Ansible manually and run this script again."
	exit 1
	;;
esac

ansible-galaxy collection install -r collections/requirements.yml

ROOTDIR="$(git rev-parse --show-toplevel 2>/dev/null)"
HOSTS="$ROOTDIR/hosts"
PLAYBOOK="$ROOTDIR/setup.yml"

if [[ -n "$CONTAINER" || -f /.dockerenv ]]; then
	if [[ -n "$ANSIBLE_VAULT_PASSWORD" ]]; then
		echo "Using vault password from environment variable"
		ansible-playbook -i "$HOSTS" "$PLAYBOOK" --become --vault-password-file <(echo "$ANSIBLE_VAULT_PASSWORD")
	else
		echo "ANSIBLE_VAULT_PASSWORD not set, prompting for vault password"
		ansible-playbook -i "$HOSTS" "$PLAYBOOK" --become --ask-vault-pass
	fi
else
	echo "The BECOME password is your sudo password."
	ansible-playbook -i "$HOSTS" "$PLAYBOOK" --ask-become-pass --ask-vault-pass
fi

echo "Ansible: Bootstrap complete. Successfully set up dev environment."

exit 0

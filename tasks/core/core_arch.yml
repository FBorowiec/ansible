---
- name: Update and upgrade pacman packages
  community.general.pacman:
    update_cache: true
    upgrade: true
  when: ansible_os_family == "Archlinux"

- name: Arch-specific core tasks
  when: ansible_os_family == "Archlinux"
  block:
    - name: Install system packages and tools (Arch Linux)
      community.general.pacman:
        name:
          - bat
          - base-devel
          - curl
          - ca-certificates
          - gettext
          - fzf
          - git
          - git-lfs
          - go
          - jq
          - lsd
          - ripgrep
          - fastfetch
          - net-tools
          - nvidia-settings
          - openssh
          - sed
          - stow
          - unzip
          - vlc
          - wget
          - xclip
        state: present

    - name: Install i3 and required packages (Arch Linux)
      community.general.pacman:
        name:
          - i3-wm
          - i3status
          - i3blocks
          - feh
          - rofi
          - picom
          - pipewire-pulse
          - pavucontrol
          - xorg-xbacklight
          - flameshot
          - dunst
          - redshift
          - autorandr
          - polybar
          - playerctl
          - gtk-engine-murrine
          - gtk-engines
          - xsettingsd
        state: present
        update_cache: true

    - name: Install additional tools (Arch Linux)
      community.general.pacman:
        name:
          - btop
          - markdownlint
          - spotify-launcher
        state: present
        update_cache: true

- name: Install yay AUR helper
  when: ansible_os_family == "Archlinux"
    - yay_check.rc != 0
  block:
    - name: Check if yay is already installed
      ansible.builtin.command: which yay
      register: yay_check
      failed_when: false
      changed_when: false

    - name: Install yay if not present
      when: yay_check.rc != 0
      block:
        - name: Install base-devel and git (required for yay)
          community.general.pacman:
            name:
              - base-devel
              - git
            state: present
          become: true

        - name: Create temporary directory for yay installation
          ansible.builtin.tempfile:
            state: directory
            suffix: yay_install
          register: yay_temp_dir

        - name: Clone yay repository
          ansible.builtin.git:
            repo: https://aur.archlinux.org/yay.git
            dest: "{{ yay_temp_dir.path }}/yay"
            depth: 1
            version: master

        - name: Build and install yay
          ansible.builtin.command: makepkg -si --noconfirm
          args:
            chdir: "{{ yay_temp_dir.path }}/yay"
          become: true
          become_user: "{{ ansible_user }}"

        - name: Clean up temporary directory
          ansible.builtin.file:
            path: "{{ yay_temp_dir.path }}"
            state: absent

    - name: Verify yay installation
      command: yay --version
      register: yay_version
      changed_when: false

    - name: Display yay version
      debug:
        msg: "Yay installed successfully: {{ yay_version.stdout }}"
